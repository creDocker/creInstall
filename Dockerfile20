# Adapted from 
FROM tamboraorg/creubuntu:2020.0
MAINTAINER Michael Kahle <michael.kahle@yahoo.de>

ARG BUILD_YEAR=2020
ARG BUILD_MONTH=0
ARG BUILD_TAG=2020.0

#ENV DEBIAN_FRONTEND noninteractive
#ENV INITRD No
#ENV LANG en_US.UTF-8
ENV NODE_VERSION 12.16.1

LABEL Name="Node for CRE" \
      CRE=$CRE_VERSION \ 
      Year=$BUILD_YEAR \
      Month=$BUILD_MONTH \
      Version=$NODE_VERSION \
      OS="Ubuntu:$UBUNTU_VERSION" \
      Build_=$BUILD_TAG 

# Install nodejs
RUN \
  apt-get update && \
  apt-get install -y nodejs npm  ## npm not included in nodejs

ENV NPM_CONFIG_PREFIX=/cre/node/.npm-global
ENV PATH=$PATH:/cre/node/.npm-global/bin
RUN mkdir -p /cre/node/.npm-global
RUN npm -g config set user root 

# can be used to update node
RUN npm install -g n 
RUN n stable # update node
RUN npm install -g npm-install-peers
RUN npm install -g npm-add-script  
RUN npm install -g keywords
RUN npm install -g json
RUN npm install -g set-version
RUN npm install -g npm-get-version

## npm set init.author.email "example-user@example.com"
## npm config --init-author-name "AJ ONeal"
## npm set init.author.name "example_user"
## npm config set init.author.url http://iamsim.me/
### RUN npm set init.version "${CRE_VERSION}.0" 
## RUN npm config --init-version "${CRE_VERSION}.0"
## RUN npm config set init.version "${CRE_VERSION}.0"
### RUN npm set init.license "Apache-2.0"
## RUN npm config --init-license "Apache-2.0"
# npm set init.author.email "example-user@example.com" 
# npm set init.author.name "example_user" 
# npm config set init.author.url http://iamsim.me/ 
# https://docs.npmjs.com/creating-a-package-json-file#default-values-extracted-from-the-current-directory 

# https://sdkman.io/install

RUN apt-get install -y libc6
RUN apt-get install -y glibc-source 

ENV SDKMAN_DIR=/cre/sdkman
## RUN export SDKMAN_DIR="/cre/sdkman" && curl -s "https://get.sdkman.io" | bash
#RUN curl -s "https://get.sdkman.io" | bash
RUN wget -qO- "https://get.sdkman.io" | sh -s - --admin --no-path
#RUN wget "https://get.sdkman.io" -o sdk.sh 
#RUN cat sdk.sh
#RUN chmod 777 sdk.sh 
#RUN ./sdk.sh 
#RUN rm -f sdk.sh
RUN source "$SDKMAN_DIR/bin/sdkman-init.sh"

RUN mkdir -p /cre && touch /cre/versions.txt && \ 
    echo "$(date +'%F %R') \t creNode \t ${NODE_VERSION}" >> /cre/versions.txt  && \
    echo "$(date +'%F %R') \t  node \t $(node --version)" >> /cre/versions.txt && \
    echo "$(date +'%F %R') \t  npm \t $(npm --version)" >> /cre/versions.txt && \ 
    echo "$(date +'%F %R') \t  sdk \t $(sdk version)" >> /cre/versions.txt

COPY cre /cre

WORKDIR "/cre/node"

ENTRYPOINT ["/cre/node-entrypoint.sh"]

CMD ["shoreman", "/cre/node-procfile"]
